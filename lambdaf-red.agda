-- Reduction of Î»F

module LambdaF-Red where

open import LambdaF
open import Data.Nat using (â„•; zero; suc; _+_)
open import Data.Bool using (true; false; if_then_else_) renaming (Bool to ğ”¹)
open import Data.String using (String)
open import Relation.Binary.PropositionalEquality

-- Substitution
data SubstVal {var : Ty â†’ Set} : {Ï„â‚ Ï„â‚‚ : Ty} â†’
              (var Ï„â‚ â†’ Val[ var ] Ï„â‚‚) â†’
              Val[ var ] Ï„â‚ â†’
              Val[ var ] Ï„â‚‚ â†’ Set 
              
data Subst {var : Ty â†’ Set} : {Ï„â‚ Ï„â‚‚ Ï„â‚ƒ Ï„â‚„ : Ty} {Î¼Î± Î¼Î² : Tr} â†’
           (var Ï„â‚ â†’ Exp[ var ] Ï„â‚‚ âŸ¨ Î¼Î± âŸ© Ï„â‚ƒ âŸ¨ Î¼Î² âŸ© Ï„â‚„) â†’
           Val[ var ] Ï„â‚ â†’
           Exp[ var ] Ï„â‚‚ âŸ¨ Î¼Î± âŸ© Ï„â‚ƒ âŸ¨ Î¼Î² âŸ© Ï„â‚„ â†’ Set 

data SubstVal {var} where
  sVar= : {Ï„ : Ty} {v : Val[ var ] Ï„} â†’
          SubstVal (Î» x â†’ Var x) v v

  sVarâ‰  : {Ï„â‚ Ï„â‚‚ : Ty} {v : Val[ var ] Ï„â‚‚} {x : var Ï„â‚} â†’
          SubstVal (Î» y â†’ Var x) v (Var x)

  sNum  : {Ï„ : Ty} {n : â„•}
          {v : Val[ var ] Ï„} â†’
          SubstVal (Î» x â†’ Num n) v (Num n)

  sBol  : {Ï„ : Ty} {b : ğ”¹}
          {v : Val[ var ] Ï„} â†’
          SubstVal (Î» x â†’ Bol b) v (Bol b)

  sStr  : {Ï„ : Ty} {s : String}
          {v : Val[ var ] Ï„} â†’
          SubstVal (Î» x â†’ Str s) v (Str s)

  sAbs  : {Ï„ Ï„â‚ Ï„â‚‚ Î± Î² Î³ : Ty} {Î¼Î± Î¼Î² : Tr}
          {e : var Ï„â‚ â†’ var Ï„ â†’ Exp[ var ] Ï„â‚‚ âŸ¨ Î¼Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î²}
          {v : Val[ var ] Ï„â‚}
          {e' : var Ï„ â†’ Exp[ var ] Ï„â‚‚ âŸ¨ Î¼Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î²} â†’
          ((x : var Ï„) â†’ Subst (Î» y â†’ (e y) x) v (e' x)) â†’
          SubstVal (Î» y â†’ Abs (e y)) v (Abs e')

data Subst {var} where
  sVal  : {Ï„ Ï„â‚ Ï„â‚ƒ : Ty} {Î¼Î± : Tr}
          {vâ‚ : var Ï„ â†’ Val[ var ] Ï„â‚}
          {v : Val[ var ] Ï„}
          {vâ‚' : Val[ var ] Ï„â‚} â†’
          SubstVal vâ‚ v vâ‚' â†’
          Subst {Ï„â‚ƒ = Ï„â‚ƒ} {Î¼Î± = Î¼Î±} (Î» y â†’ Val (vâ‚ y)) v (Val vâ‚')

  sApp  : {Ï„ Ï„â‚ Ï„â‚‚ Î± Î² Î³ Î´ : Ty} {Î¼Î± Î¼Î² Î¼Î³ Î¼Î´ : Tr}
          {eâ‚ : var Ï„ â†’ Exp[ var ] (Ï„â‚ â‡’ Ï„â‚‚ âŸ¨ Î¼Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î²) âŸ¨ Î¼Î³ âŸ© Î³ âŸ¨ Î¼Î´ âŸ© Î´}
          {eâ‚‚ : var Ï„ â†’ Exp[ var ] Ï„â‚ âŸ¨ Î¼Î² âŸ© Î² âŸ¨ Î¼Î³ âŸ© Î³}
          {v : Val[ var ] Ï„}
          {eâ‚' : Exp[ var ] (Ï„â‚ â‡’ Ï„â‚‚ âŸ¨ Î¼Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î²) âŸ¨ Î¼Î³ âŸ© Î³ âŸ¨ Î¼Î´ âŸ© Î´}
          {eâ‚‚' : Exp[ var ] Ï„â‚ âŸ¨ Î¼Î² âŸ© Î² âŸ¨ Î¼Î³ âŸ© Î³} â†’
          Subst eâ‚ v eâ‚' â†’ Subst eâ‚‚ v eâ‚‚' â†’
          Subst (Î» y â†’ App (eâ‚ y) (eâ‚‚ y)) v (App eâ‚' eâ‚‚')

  sPlu : {Ï„ Î± Î² Î³ : Ty} {Î¼Î± Î¼Î² Î¼Î³ : Tr}
         {eâ‚ : var Ï„ â†’ Exp[ var ] Nat âŸ¨ Î¼Î² âŸ© Î² âŸ¨ Î¼Î³ âŸ© Î³}
         {eâ‚‚ : var Ï„ â†’ Exp[ var ] Nat âŸ¨ Î¼Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î²}
         {v : Val[ var ] Ï„}
         {eâ‚' : Exp[ var ] Nat âŸ¨ Î¼Î² âŸ© Î² âŸ¨ Î¼Î³ âŸ© Î³ }
         {eâ‚‚' : Exp[ var ] Nat âŸ¨ Î¼Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î²  } â†’
         Subst eâ‚ v eâ‚' â†’ Subst eâ‚‚ v eâ‚‚' â†’
         Subst (Î» y â†’ Plus (eâ‚ y) (eâ‚‚ y)) v (Plus eâ‚' eâ‚‚')

  sIs0 : {Ï„ Î± Î² : Ty} {Î¼Î± Î¼Î² : Tr}
         {e : var Ï„ â†’ Exp[ var ] Nat âŸ¨ Î¼Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î²}
         {v : Val[ var ] Ï„}
         {e' : Exp[ var ] Nat âŸ¨ Î¼Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î²  } â†’
         Subst e v e' â†’ 
         Subst (Î» y â†’ Is0 (e y)) v (Is0 e')

  sB2S : {Ï„ Î± Î² : Ty} {Î¼Î± Î¼Î² : Tr}
         {e : var Ï„ â†’ Exp[ var ] Bool âŸ¨ Î¼Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î²}
         {v : Val[ var ] Ï„}
         {e' : Exp[ var ] Bool âŸ¨ Î¼Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î²} â†’
         Subst e v e' â†’ 
         Subst (Î» y â†’ B2S (e y)) v (B2S e')

  sCon : {Ï„ Ï„â‚ Ï„â‚' Ï„â‚ƒ Î± Î² Î³ Î³' : Ty} {Î¼â‚€ Î¼â‚ Î¼â‚‚ Î¼áµ¢ Î¼Î± Î¼Î² : Tr} â†’
         {e : var Ï„â‚ƒ â†’
              var (Ï„ â‡’ Ï„â‚ âŸ¨ Î¼â‚ âŸ© Ï„â‚' âŸ¨ Î¼â‚‚ âŸ© Î±) â†’
              Exp[ var ] Î³ âŸ¨ Î¼áµ¢ âŸ© Î³' âŸ¨ â— âŸ© Î²}
         {v : Val[ var ] Ï„â‚ƒ}
         {e' : var (Ï„ â‡’ Ï„â‚ âŸ¨ Î¼â‚ âŸ© Ï„â‚' âŸ¨ Î¼â‚‚ âŸ© Î±) â†’
               Exp[ var ] Î³ âŸ¨ Î¼áµ¢ âŸ© Î³' âŸ¨ â— âŸ© Î²}
         {xâ‚ : id-cont-type Î³ Î¼áµ¢ Î³'}
         {xâ‚‚ : compatible (Ï„â‚ â‡’âŸ¨ Î¼â‚ âŸ© Ï„â‚') Î¼â‚‚ Î¼â‚€}
         {xâ‚ƒ : compatible  Î¼Î² Î¼â‚€ Î¼Î±} â†’
         ((k : var (Ï„ â‡’ Ï„â‚ âŸ¨ Î¼â‚ âŸ© Ï„â‚' âŸ¨ Î¼â‚‚ âŸ© Î±)) â†’
               Subst (Î» y â†’ (e y) k) v ((e' k))) â†’
         Subst (Î» y â†’ Control xâ‚ xâ‚‚ xâ‚ƒ (e y))
               v
               (Control xâ‚ xâ‚‚ xâ‚ƒ e')

  sPro : {Ï„ Ï„â‚ƒ Î² Î²' Î³ : Ty} {Î¼áµ¢ Î¼Î± : Tr}
         {e : var Ï„ â†’ Exp[ var ] Î² âŸ¨ Î¼áµ¢ âŸ© Î²' âŸ¨ â— âŸ© Î³}
         {v : Val[ var ] Ï„}
         {e' : Exp[ var ] Î² âŸ¨ Î¼áµ¢ âŸ© Î²' âŸ¨ â— âŸ© Î³}
         {x : id-cont-type Î² Î¼áµ¢ Î²'} â†’
         Subst e v e' â†’
         Subst {Ï„â‚ƒ = Ï„â‚ƒ} {Î¼Î± = Î¼Î±} (Î» y â†’ Prompt x (e y)) v
               (Prompt x e')
               

-- Frames
data Fr[_,_âŸ¨_âŸ©_âŸ¨_âŸ©_]_âŸ¨_âŸ©_âŸ¨_âŸ©_ (var : Ty â†’ Set)
       : Ty â†’ Tr â†’ Ty â†’ Tr â†’ Ty â†’ Ty â†’ Tr â†’ Ty â†’ Tr â†’ Ty â†’ Set where

  Appâ‚  : {Ï„â‚ Ï„â‚‚ Î± Î² Î³ Î´ : Ty} {Î¼Î± Î¼Î² Î¼Î³ Î¼Î´ : Tr} â†’
          (eâ‚‚ : Exp[ var ] Ï„â‚ âŸ¨ Î¼Î² âŸ© Î² âŸ¨ Î¼Î³ âŸ© Î³) â†’
          Fr[ var , (Ï„â‚ â‡’ Ï„â‚‚ âŸ¨ Î¼Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î²) âŸ¨ Î¼Î³ âŸ© Î³ âŸ¨ Î¼Î´ âŸ© Î´ ]
            Ï„â‚‚ âŸ¨ Î¼Î± âŸ© Î± âŸ¨ Î¼Î´ âŸ© Î´

  Appâ‚‚  : {Ï„â‚ Ï„â‚‚ Î± Î² Î³ : Ty} {Î¼Î± Î¼Î² Î¼Î³ : Tr} â†’
          (vâ‚ : Val[ var ] (Ï„â‚ â‡’ Ï„â‚‚ âŸ¨ Î¼Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î²)) â†’
          Fr[ var , Ï„â‚ âŸ¨ Î¼Î² âŸ© Î² âŸ¨ Î¼Î³ âŸ© Î³ ]
            Ï„â‚‚ âŸ¨ Î¼Î± âŸ© Î± âŸ¨ Î¼Î³ âŸ© Î³

  Plusâ‚ : {Î± Î² Î³ : Ty} {Î¼Î± Î¼Î² Î¼Î³ : Tr} â†’
          (eâ‚‚ : Exp[ var ] Nat âŸ¨ Î¼Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î²) â†’
          Fr[ var , Nat âŸ¨ Î¼Î² âŸ© Î² âŸ¨ Î¼Î³ âŸ© Î³ ] Nat âŸ¨ Î¼Î± âŸ© Î± âŸ¨ Î¼Î³ âŸ© Î³

  Plusâ‚‚ : {Î± Î³ : Ty} {Î¼Î± Î¼Î³ : Tr} â†’
          (vâ‚ : Val[ var ] Nat) â†’
          Fr[ var , Nat âŸ¨ Î¼Î± âŸ© Î± âŸ¨ Î¼Î³ âŸ© Î³ ] Nat âŸ¨ Î¼Î± âŸ© Î± âŸ¨ Î¼Î³ âŸ© Î³

  Is0   : {Î± Î² : Ty} {Î¼Î± Î¼Î² : Tr} â†’
          Fr[ var , Nat âŸ¨ Î¼Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î² ] Bool âŸ¨ Î¼Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î²

  B2S   : {Î± Î² : Ty} {Î¼Î± Î¼Î² : Tr} â†’
          Fr[ var , Bool âŸ¨ Î¼Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î² ] Str âŸ¨ Î¼Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î²
            
  Pro   : {Ï„ Î± Î² Î²' : Ty} {Î¼áµ¢ Î¼Î± : Tr} â†’
          (id-cont-type Î² Î¼áµ¢ Î²') â†’
          Fr[ var , Î² âŸ¨ Î¼áµ¢ âŸ© Î²' âŸ¨ â— âŸ© Ï„ ] Ï„ âŸ¨ Î¼Î± âŸ© Î± âŸ¨ Î¼Î± âŸ© Î±

Fr-plug : {var : Ty â†’ Set}
          {Ï„â‚ Ï„â‚‚ Ï„â‚ƒ Ï„â‚„ Ï„â‚… Ï„â‚† : Ty} {Î¼Î± Î¼Î² Î¼Î³ Î¼Î´ : Tr} â†’
          Fr[ var , Ï„â‚‚ âŸ¨ Î¼Î± âŸ© Ï„â‚„ âŸ¨ Î¼Î² âŸ© Ï„â‚… ] Ï„â‚ âŸ¨ Î¼Î³ âŸ© Ï„â‚ƒ âŸ¨ Î¼Î´ âŸ© Ï„â‚† â†’
          Exp[ var ] Ï„â‚‚ âŸ¨ Î¼Î± âŸ© Ï„â‚„ âŸ¨ Î¼Î² âŸ© Ï„â‚… â†’
          Exp[ var ] Ï„â‚ âŸ¨ Î¼Î³ âŸ© Ï„â‚ƒ âŸ¨ Î¼Î´ âŸ© Ï„â‚†

Fr-plug (Appâ‚ eâ‚‚) eâ‚ = App eâ‚ eâ‚‚
Fr-plug (Appâ‚‚ vâ‚) eâ‚‚ = App (Val vâ‚) eâ‚‚
Fr-plug (Plusâ‚ eâ‚‚) eâ‚ = Plus eâ‚ eâ‚‚
Fr-plug (Plusâ‚‚ vâ‚) eâ‚‚ = Plus (Val vâ‚) eâ‚‚
Fr-plug Is0 e = Is0 e
Fr-plug B2S e = B2S e
Fr-plug {Ï„â‚ = Ï„â‚} {Ï„â‚‚ = Ï„â‚‚} {Ï„â‚ƒ = Ï„â‚ƒ} {Ï„â‚„ = Ï„â‚„} {Î¼Î± = Î¼Î±} {Î¼Î³ = Î¼Î³} (Pro x) e =
  Prompt x e

-- Pure frames
data pFr[_,_âŸ¨_âŸ©_âŸ¨_âŸ©_]_âŸ¨_âŸ©_âŸ¨_âŸ©_ (var : Ty â†’ Set)
       : Ty â†’ Tr â†’ Ty â†’ Tr â†’ Ty â†’ Ty â†’ Tr â†’ Ty â†’ Tr â†’ Ty â†’ Set where
  Appâ‚ : {Ï„â‚ Ï„â‚‚ Î± Î² Î³ Î´ : Ty} {Î¼Î± Î¼Î² Î¼Î³ Î¼Î´ : Tr} â†’
         (eâ‚‚ : Exp[ var ] Ï„â‚ âŸ¨ Î¼Î² âŸ© Î² âŸ¨ Î¼Î³ âŸ© Î³) â†’
         pFr[ var , (Ï„â‚ â‡’ Ï„â‚‚ âŸ¨ Î¼Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î²) âŸ¨ Î¼Î³ âŸ© Î³ âŸ¨ Î¼Î´ âŸ© Î´ ]
            Ï„â‚‚ âŸ¨ Î¼Î± âŸ© Î± âŸ¨ Î¼Î´ âŸ© Î´

  Appâ‚‚ : {Ï„â‚ Ï„â‚‚ Î± Î² Î³ : Ty} {Î¼Î± Î¼Î² Î¼Î³ : Tr} â†’
         (vâ‚ : Val[ var ] (Ï„â‚ â‡’ Ï„â‚‚ âŸ¨ Î¼Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î²)) â†’
         pFr[ var , Ï„â‚ âŸ¨ Î¼Î² âŸ© Î² âŸ¨ Î¼Î³ âŸ© Î³ ]
            Ï„â‚‚ âŸ¨ Î¼Î± âŸ© Î± âŸ¨ Î¼Î³ âŸ© Î³

  Plusâ‚ : {Î± Î² Î³ : Ty} {Î¼Î± Î¼Î² Î¼Î³ : Tr} â†’
          (eâ‚‚ : Exp[ var ] Nat âŸ¨ Î¼Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î²) â†’
          pFr[ var , Nat âŸ¨ Î¼Î² âŸ© Î² âŸ¨ Î¼Î³ âŸ© Î³ ] Nat âŸ¨ Î¼Î± âŸ© Î± âŸ¨ Î¼Î³ âŸ© Î³

  Plusâ‚‚ : {Î± Î³ : Ty} {Î¼Î± Î¼Î³ : Tr} â†’
          (vâ‚ : Val[ var ] Nat) â†’
          pFr[ var , Nat âŸ¨ Î¼Î± âŸ© Î± âŸ¨ Î¼Î³ âŸ© Î³ ] Nat âŸ¨ Î¼Î± âŸ© Î± âŸ¨ Î¼Î³ âŸ© Î³

  Is0   : {Î± Î² : Ty} {Î¼Î± Î¼Î² : Tr} â†’
          pFr[ var , Nat âŸ¨ Î¼Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î² ] Bool âŸ¨ Î¼Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î²
  B2S   : {Î± Î² : Ty} {Î¼Î± Î¼Î² : Tr} â†’
          pFr[ var , Bool âŸ¨ Î¼Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î² ] Str âŸ¨ Î¼Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î²
       
pFr-plug : {var : Ty â†’ Set}
           {Ï„â‚ Ï„â‚‚ Ï„â‚ƒ Ï„â‚„ Ï„â‚… Ï„â‚† : Ty} {Î¼Î± Î¼Î² Î¼Î³ Î¼Î´ : Tr} â†’
           pFr[ var , Ï„â‚ âŸ¨ Î¼Î± âŸ© Ï„â‚‚ âŸ¨ Î¼Î² âŸ© Ï„â‚ƒ ] Ï„â‚„ âŸ¨ Î¼Î³ âŸ© Ï„â‚… âŸ¨ Î¼Î´ âŸ© Ï„â‚† â†’
           Exp[ var ] Ï„â‚ âŸ¨ Î¼Î± âŸ© Ï„â‚‚ âŸ¨ Î¼Î² âŸ© Ï„â‚ƒ â†’
           Exp[ var ] Ï„â‚„ âŸ¨ Î¼Î³ âŸ© Ï„â‚… âŸ¨ Î¼Î´ âŸ© Ï„â‚†

pFr-plug (Appâ‚ eâ‚‚) eâ‚ = App eâ‚ eâ‚‚
pFr-plug (Appâ‚‚ vâ‚) eâ‚‚ = App (Val vâ‚) eâ‚‚
pFr-plug (Plusâ‚ eâ‚‚) eâ‚ = Plus eâ‚ eâ‚‚
pFr-plug (Plusâ‚‚ vâ‚) eâ‚‚ = Plus (Val vâ‚) eâ‚‚
pFr-plug Is0 e = Is0 e
pFr-plug B2S e = B2S e

data same-pFr {var : Ty â†’ Set}:
              {Ï„â‚ Ï„â‚' Ï„â‚‚ Ï„â‚‚' Ï„â‚ƒ Ï„â‚ƒ' Ï„â‚„ Ï„â‚„' Ï„â‚… Ï„â‚…' Ï„â‚† Ï„â‚†' : Ty}
              {Î¼Î± Î¼Î±' Î¼Î² Î¼Î²' Î¼Î³ Î¼Î³' Î¼Î´ Î¼Î´' : Tr} â†’
              pFr[ var , Ï„â‚ âŸ¨ Î¼Î± âŸ© Ï„â‚‚ âŸ¨ Î¼Î² âŸ© Ï„â‚ƒ ] Ï„â‚„ âŸ¨ Î¼Î³ âŸ© Ï„â‚… âŸ¨ Î¼Î´ âŸ© Ï„â‚† â†’
              pFr[ var , Ï„â‚' âŸ¨ Î¼Î±' âŸ© Ï„â‚‚' âŸ¨ Î¼Î²' âŸ© Ï„â‚ƒ' ] Ï„â‚„' âŸ¨ Î¼Î³' âŸ© Ï„â‚…' âŸ¨ Î¼Î´' âŸ© Ï„â‚†' â†’
              Set where
  Appâ‚ : {Ï„ Î² Î³ Ï„â‚ƒ Ï„â‚ƒ' Ï„â‚„ Ï„â‚„' Ï„â‚… Ï„â‚…' : Ty} {Î¼â‚ Î¼â‚‚ Î¼Î² Î¼Î²' Î¼Î³ Î¼Î³' : Tr} â†’
         (eâ‚‚ : Exp[ var ] Ï„ âŸ¨ Î¼â‚ âŸ© Î² âŸ¨ Î¼â‚‚ âŸ© Î³) â†’
         same-pFr {Ï„â‚ƒ = Ï„â‚ƒ} {Ï„â‚ƒ'} {Ï„â‚„} {Ï„â‚„'} {Ï„â‚…} {Ï„â‚…'} {Î¼Î² = Î¼Î²} {Î¼Î²'} {Î¼Î³} {Î¼Î³'}
                  (Appâ‚ eâ‚‚) (Appâ‚ eâ‚‚)
  Appâ‚‚ : {Ï„â‚ Ï„â‚‚ Î± Î² Ï„â‚ƒ Ï„â‚ƒ' : Ty} {Î¼â‚ Î¼â‚‚ Î¼Î² Î¼Î²' : Tr} â†’
         (vâ‚ : Val[ var ] (Ï„â‚ â‡’ Ï„â‚‚ âŸ¨ Î¼â‚ âŸ© Î± âŸ¨ Î¼â‚‚ âŸ© Î²) ) â†’
         same-pFr {Ï„â‚ƒ = Ï„â‚ƒ} {Ï„â‚ƒ'} {Î¼Î² = Î¼Î²} {Î¼Î²'}
                  (Appâ‚‚ vâ‚) (Appâ‚‚ vâ‚)

  Plusâ‚ : {Î± Î² Î³ Ï„â‚ƒ Ï„â‚ƒ' : Ty} {Î¼Î± Î¼Î² Î¼Î³ Î¼Î²' : Tr} â†’
          (eâ‚‚ : Exp[ var ] Nat âŸ¨ Î¼Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î²) â†’
          same-pFr {Ï„â‚ƒ = Ï„â‚ƒ} {Ï„â‚ƒ'} {Î¼Î² = Î¼Î²} {Î¼Î²'}
                   (Plusâ‚ eâ‚‚) (Plusâ‚ eâ‚‚)

  Plusâ‚‚ : {Ï„â‚‚ Ï„â‚‚' Ï„â‚ƒ Ï„â‚ƒ' : Ty} {Î¼Î± Î¼Î±' Î¼Î² Î¼Î²' : Tr} â†’
          (vâ‚ : Val[ var ] Nat) â†’
          same-pFr {Ï„â‚‚ = Ï„â‚‚} {Ï„â‚‚'} {Ï„â‚ƒ} {Ï„â‚ƒ'} {Î¼Î± = Î¼Î±} {Î¼Î±'} {Î¼Î²} {Î¼Î²'}
                   (Plusâ‚‚ vâ‚) (Plusâ‚‚ vâ‚)

  Is0   : {Ï„â‚‚ Ï„â‚‚' Ï„â‚ƒ Ï„â‚ƒ' : Ty} {Î¼Î± Î¼Î±' Î¼Î² Î¼Î²' : Tr} â†’
          same-pFr {Ï„â‚‚ = Ï„â‚‚} {Ï„â‚‚'} {Ï„â‚ƒ} {Ï„â‚ƒ'} {Î¼Î± = Î¼Î±} {Î¼Î±'} {Î¼Î²} {Î¼Î²'}
                   Is0 Is0

  B2S   : {Ï„â‚‚ Ï„â‚‚' Ï„â‚ƒ Ï„â‚ƒ' : Ty} {Î¼Î± Î¼Î±' Î¼Î² Î¼Î²' : Tr} â†’
          same-pFr {Ï„â‚‚ = Ï„â‚‚} {Ï„â‚‚'} {Ï„â‚ƒ} {Ï„â‚ƒ'} {Î¼Î± = Î¼Î±} {Î¼Î±'} {Î¼Î²} {Î¼Î²'}
                   B2S B2S

-- Pure contexts
data pCxt[_,_âŸ¨_âŸ©_âŸ¨_âŸ©_]_âŸ¨_âŸ©_âŸ¨_âŸ©_ (var : Ty â†’ Set)
       : Ty â†’ Tr â†’ Ty â†’ Tr â†’ Ty â†’ Ty â†’ Tr â†’ Ty â†’ Tr â†’ Ty â†’ Set where
  Hole : {Ï„â‚ Ï„â‚‚ Ï„â‚ƒ : Ty} {Î¼Î± Î¼Î² : Tr} â†’
          pCxt[ var , Ï„â‚ âŸ¨ Î¼Î± âŸ© Ï„â‚‚ âŸ¨ Î¼Î² âŸ© Ï„â‚ƒ ] Ï„â‚ âŸ¨ Î¼Î± âŸ© Ï„â‚‚ âŸ¨ Î¼Î² âŸ© Ï„â‚ƒ
  Fr   : {Ï„â‚ Ï„â‚‚ Ï„â‚ƒ Ï„â‚„ Ï„â‚… Ï„â‚† Ï„â‚‡ Ï„â‚ˆ Ï„â‚‰ : Ty}{Î¼â‚ Î¼â‚‚ Î¼â‚ƒ Î¼â‚„ Î¼â‚… Î¼â‚† : Tr} â†’
         (f : pFr[ var , Ï„â‚„ âŸ¨ Î¼â‚ƒ âŸ© Ï„â‚… âŸ¨ Î¼â‚„ âŸ© Ï„â‚† ] Ï„â‚‡ âŸ¨ Î¼â‚… âŸ© Ï„â‚ˆ âŸ¨ Î¼â‚† âŸ© Ï„â‚‰) â†’
         (c : pCxt[ var , Ï„â‚ âŸ¨ Î¼â‚ âŸ© Ï„â‚‚ âŸ¨ Î¼â‚‚ âŸ© Ï„â‚ƒ ] Ï„â‚„ âŸ¨ Î¼â‚ƒ âŸ© Ï„â‚… âŸ¨ Î¼â‚„ âŸ© Ï„â‚†) â†’
         pCxt[ var , Ï„â‚ âŸ¨ Î¼â‚ âŸ© Ï„â‚‚ âŸ¨ Î¼â‚‚ âŸ© Ï„â‚ƒ ] Ï„â‚‡ âŸ¨ Î¼â‚… âŸ© Ï„â‚ˆ âŸ¨ Î¼â‚† âŸ© Ï„â‚‰

pCxt-plug : {var : Ty â†’ Set}
            {Ï„â‚ Ï„â‚‚ Ï„â‚ƒ Ï„â‚„ Ï„â‚… Ï„â‚† : Ty}{Î¼Î± Î¼Î² Î¼Î³ Î¼Î´ : Tr} â†’
            pCxt[ var , Ï„â‚ âŸ¨ Î¼Î± âŸ© Ï„â‚‚ âŸ¨ Î¼Î² âŸ© Ï„â‚ƒ ] Ï„â‚„ âŸ¨ Î¼Î³ âŸ© Ï„â‚… âŸ¨ Î¼Î´ âŸ© Ï„â‚† â†’
            Exp[ var ] Ï„â‚ âŸ¨ Î¼Î± âŸ© Ï„â‚‚ âŸ¨ Î¼Î² âŸ© Ï„â‚ƒ â†’
            Exp[ var ] Ï„â‚„ âŸ¨ Î¼Î³ âŸ© Ï„â‚… âŸ¨ Î¼Î´ âŸ© Ï„â‚†

pCxt-plug Hole eâ‚ = eâ‚
pCxt-plug (Fr f p) eâ‚ = pFr-plug f (pCxt-plug p eâ‚)

data same-pCxt {var : Ty â†’ Set} :
               {Ï„â‚ Ï„â‚' Ï„â‚‚ Ï„â‚‚' Ï„â‚ƒ Ï„â‚ƒ' Ï„â‚„ Ï„â‚„' Ï„â‚… Ï„â‚…' Ï„â‚† Ï„â‚†' : Ty}
               {Î¼Î± Î¼Î±' Î¼Î² Î¼Î²' Î¼Î³ Î¼Î³' Î¼Î´ Î¼Î´' : Tr} â†’
               pCxt[ var , Ï„â‚ âŸ¨ Î¼Î± âŸ© Ï„â‚‚ âŸ¨ Î¼Î² âŸ© Ï„â‚ƒ ] Ï„â‚„ âŸ¨ Î¼Î³ âŸ© Ï„â‚… âŸ¨ Î¼Î´ âŸ© Ï„â‚† â†’
               pCxt[ var , Ï„â‚' âŸ¨ Î¼Î±' âŸ© Ï„â‚‚' âŸ¨ Î¼Î²' âŸ© Ï„â‚ƒ' ] Ï„â‚„' âŸ¨ Î¼Î³' âŸ© Ï„â‚…' âŸ¨ Î¼Î´' âŸ© Ï„â‚†' â†’
               Set where
  Hole  : {Ï„â‚ Ï„â‚' Ï„â‚‚ Ï„â‚‚' Ï„â‚ƒ Ï„â‚ƒ' : Ty} {Î¼Î± Î¼Î±' Î¼Î² Î¼Î²' : Tr} â†’
          same-pCxt {Ï„â‚ = Ï„â‚} {Ï„â‚'} {Ï„â‚‚} {Ï„â‚‚'} {Ï„â‚ƒ} {Ï„â‚ƒ'} {Î¼Î± = Î¼Î±} {Î¼Î±'} {Î¼Î²} {Î¼Î²'}
                    Hole Hole
  Fr : {Ï„â‚ Ï„â‚' Ï„â‚‚ Ï„â‚‚' Ï„â‚ƒ Ï„â‚ƒ' Ï„â‚„ Ï„â‚„' Ï„â‚… Ï„â‚…' Ï„â‚† Ï„â‚†' Ï„â‚‡ Ï„â‚‡' Ï„â‚ˆ' Ï„â‚ˆ Ï„â‚‰ Ï„â‚‰' : Ty}
       {Î¼â‚ Î¼â‚' Î¼â‚‚ Î¼â‚‚' Î¼â‚ƒ Î¼â‚ƒ' Î¼â‚„ Î¼â‚„' Î¼â‚… Î¼â‚…' Î¼â‚† Î¼â‚†' : Tr} â†’
       {fâ‚ : pFr[ var , Ï„â‚„ âŸ¨ Î¼â‚ƒ âŸ© Ï„â‚… âŸ¨ Î¼â‚„ âŸ© Ï„â‚† ] Ï„â‚‡ âŸ¨ Î¼â‚… âŸ© Ï„â‚ˆ âŸ¨ Î¼â‚† âŸ© Ï„â‚‰} â†’
       {fâ‚‚ : pFr[ var , Ï„â‚„' âŸ¨ Î¼â‚ƒ' âŸ© Ï„â‚…' âŸ¨ Î¼â‚„' âŸ© Ï„â‚†' ] Ï„â‚‡' âŸ¨ Î¼â‚…' âŸ© Ï„â‚ˆ' âŸ¨ Î¼â‚†' âŸ© Ï„â‚‰'} â†’
       same-pFr fâ‚ fâ‚‚ â†’
       {câ‚ : pCxt[ var , Ï„â‚ âŸ¨ Î¼â‚ âŸ© Ï„â‚‚ âŸ¨ Î¼â‚‚ âŸ© Ï„â‚ƒ ] Ï„â‚„ âŸ¨ Î¼â‚ƒ âŸ© Ï„â‚… âŸ¨ Î¼â‚„ âŸ© Ï„â‚†} â†’
       {câ‚‚ : pCxt[ var , Ï„â‚' âŸ¨ Î¼â‚' âŸ© Ï„â‚‚' âŸ¨ Î¼â‚‚' âŸ© Ï„â‚ƒ' ] Ï„â‚„' âŸ¨ Î¼â‚ƒ' âŸ© Ï„â‚…' âŸ¨ Î¼â‚„' âŸ© Ï„â‚†'} â†’
       same-pCxt câ‚ câ‚‚ â†’
       same-pCxt (Fr fâ‚ câ‚) (Fr fâ‚‚ câ‚‚)


-- One-step reduction (proof of Theorem 1)
data Reduce {var : Ty â†’ Set} :
            {Ï„ Î± Î² : Ty} {Î¼Î± Î¼Î² : Tr} â†’
            Exp[ var ] Ï„ âŸ¨ Î¼Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î² â†’
            Exp[ var ] Ï„ âŸ¨ Î¼Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î² â†’ Set where

  RBeta   : {Ï„â‚ Ï„â‚‚ Î± Î² : Ty} {Î¼Î± Î¼Î² : Tr} â†’
            {e : var Ï„â‚ â†’ Exp[ var ] Ï„â‚‚ âŸ¨ Î¼Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î²} â†’
            {v : Val[ var ] Ï„â‚} â†’
            {e' : Exp[ var ] Ï„â‚‚ âŸ¨ Î¼Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î²} â†’
            Subst e v e' â†’
            Reduce (App (Val (Abs e)) (Val v)) e'

  RPlus   : {Î± : Ty} {Î¼Î± : Tr} {nâ‚ nâ‚‚ : â„•} â†’
            Reduce {Î± = Î±} {Î¼Î± = Î¼Î±}
                   (Plus (Val (Num nâ‚)) (Val (Num nâ‚‚))) (Val (Num (nâ‚ + nâ‚‚)))

  RIs0    : {Î± : Ty} {Î¼Î± : Tr} {n : â„•} â†’
            Reduce {Î± = Î±} {Î¼Î± = Î¼Î±}
                   (Is0 (Val (Num n))) (Val (Bol (is0 n)))

  RB2S    : {Î± : Ty} {Î¼Î± : Tr} {b : ğ”¹} â†’
            Reduce {Î± = Î±} {Î¼Î± = Î¼Î±}
                   (B2S (Val (Bol b))) (Val (Str (b2s b)))

  RPrompt : {Ï„ Î± : Ty} {Î¼Î± : Tr} â†’
            {v : Val[ var ] Ï„} â†’
            Reduce {Î± = Î±} {Î¼Î± = Î¼Î±}
                   (Prompt refl (Val v)) (Val v)
            
  RControl : {Ï„ Î± Î±' Î² Î²' Î³ Î³' tâ‚ tâ‚‚ Ï„â‚ Ï„â‚‚ : Ty}
             {Î¼â‚€ Î¼â‚ Î¼áµ¢ Î¼Î± Î¼Î±' Î¼Î² Î¼Î²' Î¼â‚‚ Î¼â‚ƒ : Tr} â†’
             (pâ‚ : pCxt[ var , Ï„ âŸ¨ Î¼Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î² ]
                       Ï„â‚ âŸ¨ Î¼â‚ƒ âŸ© Ï„â‚‚ âŸ¨ â— âŸ© Î²) â†’
             (pâ‚‚ : pCxt[ var , Ï„ âŸ¨ Î¼Î±' âŸ© Î±' âŸ¨ Î¼Î±' âŸ© Î±' ]
                       tâ‚ âŸ¨ Î¼â‚ âŸ© tâ‚‚ âŸ¨ Î¼â‚‚ âŸ© Î±) â†’
             {xâ‚€ : id-cont-type Ï„â‚ Î¼â‚ƒ Ï„â‚‚} â†’
             (xâ‚ : id-cont-type Î³ Î¼áµ¢ Î³') â†’
             (xâ‚‚ : compatible (tâ‚ â‡’âŸ¨ Î¼â‚ âŸ© tâ‚‚) Î¼â‚‚ Î¼â‚€) â†’
             (xâ‚ƒ : compatible Î¼Î² Î¼â‚€ Î¼Î±) â†’
             same-pCxt pâ‚ pâ‚‚ â†’
             (e : var (Ï„ â‡’ tâ‚ âŸ¨ Î¼â‚ âŸ© tâ‚‚ âŸ¨ Î¼â‚‚ âŸ© Î±) â†’
                  Exp[ var ] Î³ âŸ¨ Î¼áµ¢ âŸ© Î³' âŸ¨ â— âŸ© Î²) â†’
             Reduce {Î± = Ï„â‚‚} {Î¼Î± = Î¼Î±}
                    (Prompt xâ‚€ (pCxt-plug pâ‚ (Control xâ‚ xâ‚‚ xâ‚ƒ e)))
                    (Prompt xâ‚ (App (Val (Abs e))
                      (Val (Abs (Î» x â†’ pCxt-plug pâ‚‚ (Val (Var x)))))))

  RFr     : {Ï„ Î± Î² Ï„' Î±' Î²' : Ty} {Î¼Î± Î¼Î² Î¼Î±' Î¼Î²' : Tr}
            {e e' : Exp[ var ] Ï„ âŸ¨ Î¼Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î²} â†’
            (f : Fr[ var , Ï„ âŸ¨ Î¼Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î² ]
                      Ï„' âŸ¨ Î¼Î±' âŸ© Î±' âŸ¨ Î¼Î²' âŸ© Î²') â†’
            Reduce e e' â†’
            Reduce (Fr-plug f e) (Fr-plug f e')
            
-- Multi-step reduction
data Reduce* {var : Ty â†’ Set} :
               {Ï„ Î± Î² : Ty} {Î¼Î± Î¼Î² : Tr} â†’
               Exp[ var ] Ï„ âŸ¨ Î¼Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î² â†’
               Exp[ var ] Ï„ âŸ¨ Î¼Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î² â†’ Set where

  R*Id    : {Ï„ Î± Î² : Ty} {Î¼Î± Î¼Î² : Tr} â†’
            (e : Exp[ var ] Ï„ âŸ¨ Î¼Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î²) â†’
            Reduce* e e
            
  R*Trans : {Ï„ Î± Î² : Ty} {Î¼Î± Î¼Î² : Tr} â†’
            (eâ‚ : Exp[ var ] Ï„ âŸ¨ Î¼Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î²) â†’
            (eâ‚‚ : Exp[ var ] Ï„ âŸ¨ Î¼Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î²) â†’
            (eâ‚ƒ : Exp[ var ] Ï„ âŸ¨ Î¼Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î²) â†’
            Reduce eâ‚ eâ‚‚ â†’
            Reduce* eâ‚‚ eâ‚ƒ â†’
            Reduce* eâ‚ eâ‚ƒ
